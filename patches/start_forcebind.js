(()=>{const $=s=>document.querySelector(s);const setStatus=t=>{const el=$("#status")||document.querySelector("[data-status]")||Array.from(document.querySelectorAll("*")).find(x=>/^\s*Status\s*:/i.test(x.textContent||""));if(!el)return;if(el.tagName&&el.tagName.toLowerCase()==="input")el.value=t;else if(el.nodeType===1){if(el.dataset&&("status" in el.dataset))el.textContent=t;else{const m=(el.textContent||"");el.textContent=m.replace(/Status\s*:\s*.*/i,"Status: "+t)||("Status: "+t)}}};const PH=()=>{const p=window.solana;return(p&&p.isPhantom)?p:null};function findStartBtn(){let b=$("#btnStart")||$("#startBtn")||document.querySelector("button[data-start]");if(b)return b;const all=[...document.querySelectorAll("button,input[type=button],input[type=submit]")];b=all.find(x=>(x.value||x.textContent||"").toLowerCase().includes("start wolverine"));return b||null}async function onStart(ev){try{ev&&ev.preventDefault&&ev.preventDefault();ev&&ev.stopPropagation&&ev.stopPropagation();ev&&ev.stopImmediatePropagation&&ev.stopImmediatePropagation();const b=findStartBtn();if(!b)throw new Error("START introuvable");if(b.dataset.busy==="1")return;b.dataset.busy="1";b.disabled=true;setStatus("START...");const p=PH();if(!p)throw new Error("Phantom non détecté");if(!p.isConnected||!p.publicKey)throw new Error("Connect Phantom d’abord");const budgetEl=$("#budgetUsdc")||$("#budget")||document.querySelector("input[name=budget]")||document.querySelector("input[type=number]");const budget=parseFloat(((budgetEl&&budgetEl.value)||"").replace(",","."));if(!(budget>0))throw new Error("Budget USDC invalide");const r=await fetch("/api/start",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({owner:String(p.publicKey),budgetUsdc:budget})});const j=await r.json().catch(()=>({}));if(!r.ok)throw new Error(j.error||("HTTP "+r.status));if(!j||!j.tx)throw new Error("API start: tx manquante");setStatus("Phantom...");const bytes=Uint8Array.from(atob(j.tx),c=>c.charCodeAt(0));const Tx=(window.solanaWeb3&&window.solanaWeb3.Transaction)||(window.Transaction);if(!Tx||!Tx.from)throw new Error("Transaction.from introuvable (solanaWeb3)");const tx=Tx.from(bytes);tx.feePayer=p.publicKey;if(j.recentBlockhash)tx.recentBlockhash=j.recentBlockhash;let sig=null;if(typeof p.signAndSendTransaction==="function"){const res=await p.signAndSendTransaction(tx);sig=res&&res.signature?res.signature:null}else{const signed=await p.signTransaction(tx);const raw=signed.serialize();const raw64=btoa(String.fromCharCode(...raw));const r2=await fetch("/api/send",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({tx:raw64})});const j2=await r2.json().catch(()=>({}));if(!r2.ok)throw new Error(j2.error||("HTTP "+r2.status));sig=j2.signature||null}setStatus(sig?("OK "+sig.slice(0,8)+"..."):"OK")}catch(e){setStatus("ERR "+(((e&&e.message)||String(e)).slice(0,120)));try{alert((e&&e.message)||String(e))}catch(_){} }finally{const b=findStartBtn();if(b){b.disabled=false;b.dataset.busy="0"}}}function bind(){const b=findStartBtn();if(!b)return;if(b.dataset.bound==="1")return;b.dataset.bound="1";b.addEventListener("click",onStart,true)}document.addEventListener("DOMContentLoaded",bind);window.__WOLV_BIND_START__=bind})();
