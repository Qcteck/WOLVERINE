(()=>{const $=s=>document.querySelector(s);const PH=()=>{const p=window.solana;return(p&&p.isPhantom)?p:null};async function onStart(e){try{e&&e.preventDefault&&e.preventDefault();e&&e.stopImmediatePropagation&&e.stopImmediatePropagation();const b=$("#btnStart")||$("#startBtn")||document.querySelector("button[data-start]");if(!b)return;if(b.dataset.busy==="1")return;b.dataset.busy="1";b.disabled=true;const p=PH();if(!p||!p.isConnected||!p.publicKey)throw new Error("Connect Phantom dâ€™abord (bouton Connect).");const budgetEl=$("#budgetUsdc")||$("#budget")||document.querySelector("input[name=budget]");const budget=parseFloat(((budgetEl&&budgetEl.value)||"").replace(",","."));if(!(budget>0))throw new Error("Budget USDC invalide.");const r=await fetch("/api/start",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({owner:String(p.publicKey),budgetUsdc:budget})});const j=await r.json().catch(()=>({}));if(!r.ok)throw new Error(j.error||("HTTP "+r.status));if(j&&j.tx){const b64=j.tx;const bytes=Uint8Array.from(atob(b64),c=>c.charCodeAt(0));const Tx=window.solanaWeb3&&window.solanaWeb3.Transaction;if(!Tx)throw new Error("solanaWeb3.Transaction introuvable.");const tx=Tx.from(bytes);tx.feePayer=p.publicKey;if(j.recentBlockhash)tx.recentBlockhash=j.recentBlockhash;const signed=await p.signTransaction(tx);const raw=signed.serialize();const raw64=btoa(String.fromCharCode(...raw));const r2=await fetch("/api/send",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({tx:raw64})});const j2=await r2.json().catch(()=>({}));if(!r2.ok)throw new Error(j2.error||("HTTP "+r2.status));}}catch(err){console.error(err);try{alert((err&&err.message)||String(err));}catch(_){}}finally{const b=$("#btnStart")||$("#startBtn")||document.querySelector("button[data-start]");if(b){b.disabled=false;b.dataset.busy="0"}}}function bindStart(){const b=$("#btnStart")||$("#startBtn")||document.querySelector("button[data-start]");if(!b)return;if(b.dataset.bound==="1")return;b.dataset.bound="1";b.addEventListener("click",onStart,true);}document.addEventListener("DOMContentLoaded",bindStart);window.bindStart=bindStart;})();
