(()=>{const q=(s,r=document)=>r.querySelector(s);const overlay=(()=>{let d=q("#__wolv_status__");if(d)return d;d=document.createElement("div");d.id="__wolv_status__";d.style.cssText="position:fixed;left:10px;bottom:10px;z-index:999999;background:#111;color:#fff;padding:8px 10px;border:1px solid #444;border-radius:8px;font:12px system-ui;opacity:.92;max-width:70vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis";d.textContent="WOLVERINE: READY";document.addEventListener("DOMContentLoaded",()=>document.body&&document.body.appendChild(d));if(document.body)document.body.appendChild(d);return d})();const setS=t=>{try{overlay.textContent="WOLVERINE: "+t}catch(_){}};const PH=()=>{const p=window.solana;return(p&&p.isPhantom)?p:null};const txt=x=>String((x&&((x.value??x.textContent)??""))||"").trim();const isStartEl=el=>{if(!el)return false;const t=txt(el).toLowerCase();return t.includes("start wolverine")||t.includes("start")&&t.includes("wolverine")};async function ensureConnected(p){if(p.isConnected&&p.publicKey)return;await p.connect({onlyIfTrusted:false})}async function onStart(ev,btn){try{ev&&ev.preventDefault&&ev.preventDefault();ev&&ev.stopPropagation&&ev.stopPropagation();ev&&ev.stopImmediatePropagation&&ev.stopImmediatePropagation();if(btn){if(btn.dataset.busy==="1")return;btn.dataset.busy="1";btn.disabled=true}setS("START...");const p=PH();if(!p)throw new Error("Phantom non détecté");await ensureConnected(p);if(!p.publicKey)throw new Error("Phantom non connecté");const budgetEl=q("#budgetUsdc")||q("#budget")||q("input[name=budget]")||q("input[type=number]");const budget=parseFloat(String((budgetEl&&budgetEl.value)||"").replace(",","."));if(!(budget>0))throw new Error("Budget USDC invalide");setS("API /api/start...");const r=await fetch("/api/start",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({owner:String(p.publicKey),budgetUsdc:budget})});let j={};try{j=await r.json()}catch(_){j={}}if(!r.ok)throw new Error(j.error||("HTTP "+r.status));if(!j||!j.tx)throw new Error("API start: tx manquante");setS("Phantom popup...");const b64=String(j.tx);const bytes=Uint8Array.from(atob(b64),c=>c.charCodeAt(0));const W3=window.solanaWeb3||{};const Tx=W3.Transaction; if(!Tx||!Tx.from)throw new Error("solanaWeb3.Transaction.from introuvable");const tx=Tx.from(bytes);tx.feePayer=p.publicKey;if(j.recentBlockhash)tx.recentBlockhash=j.recentBlockhash;let sig=null;if(typeof p.signAndSendTransaction==="function"){const res=await p.signAndSendTransaction(tx);sig=res&&res.signature?String(res.signature):null}else if(typeof p.signTransaction==="function"){const signed=await p.signTransaction(tx);const raw=signed.serialize();const raw64=btoa(String.fromCharCode(...raw));const r2=await fetch("/api/send",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({tx:raw64})});let j2={};try{j2=await r2.json()}catch(_){j2={}}if(!r2.ok)throw new Error(j2.error||("HTTP "+r2.status));sig=j2.signature?String(j2.signature):null}else{throw new Error("Phantom: sign* introuvable")}setS(sig?("OK "+sig.slice(0,10)+"..."):"OK")}catch(e){setS("ERR "+(((e&&e.message)||String(e)).slice(0,140)))}finally{if(btn){btn.disabled=false;btn.dataset.busy="0"}}}function install(){document.addEventListener("click",(ev)=>{const t=ev.target;const el=t&&t.closest?t.closest("button,input[type=button],input[type=submit]"):null;if(isStartEl(el))onStart(ev,el)},true);setS("READY")}install();window.__WOLV_START_FIX_V2__=install})();
