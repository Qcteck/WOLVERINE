(()=>{const q=(s,r=document)=>r.querySelector(s);const overlay=(()=>{let d=q("#__wolv_status__");if(d)return d;d=document.createElement("div");d.id="__wolv_status__";d.style.cssText="position:fixed;left:10px;bottom:10px;z-index:999999;background:#111;color:#fff;padding:8px 10px;border:1px solid #444;border-radius:8px;font:12px system-ui;opacity:.92;max-width:78vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis";d.textContent="WOLVERINE: READY";(document.body?document.body.appendChild(d):document.addEventListener("DOMContentLoaded",()=>document.body&&document.body.appendChild(d)));return d})();const setS=t=>{try{overlay.textContent="WOLVERINE: "+t}catch(_){}};const PH=()=>{const p=window.solana;return(p&&p.isPhantom)?p:null};const txt=x=>String((x&&((x.value??x.textContent)??""))||"").trim();const isStartEl=el=>{if(!el)return false;const t=txt(el).toLowerCase();return t.includes("start wolverine")||t.includes("start")&&t.includes("wolverine")};const W3=()=>window.solanaWeb3||null;const USDC="EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1";const TOKEN="TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA";const ASSOC="ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL";const SYS="11111111111111111111111111111111";const RENT="SysvarRent111111111111111111111111111111111";function u64le(x){let n=BigInt(x);const b=new Uint8Array(8);for(let i=0;i<8;i++){b[i]=Number(n&255n);n>>=8n}return b}function parseBot(){const cand=[q("#botAddress"),q("#traderoneAddress"),q("[data-bot]")].map(e=>e&&((e.value||e.textContent)||"")).filter(Boolean);if(cand[0])return cand[0].trim();const t=(document.body&&document.body.innerText)||"";const m=t.match(/Adresse:\s*([1-9A-HJ-NP-Za-km-z]{32,44})/i)||t.match(/Wallet\s*TraderOne.*?([1-9A-HJ-NP-Za-km-z]{32,44})/is);return (m&&m[1])?m[1].trim():""}function findBudget(){const el=q("#budgetUsdc")||q("#budget")||q("input[name=budget]")||q("input[type=number]");const v=parseFloat(String((el&&el.value)||"").replace(",","."));return v}function getRpc(){const el=q("meta[name=solana-rpc]");const v=(el&&el.content)||window.RPC||window.RPC_ENDPOINT||window.__RPC__||"";return String(v||"").trim()}function ata(PublicKey,owner,mint){const [a]=PublicKey.findProgramAddressSync([owner.toBuffer(),new PublicKey(TOKEN).toBuffer(),mint.toBuffer()],new PublicKey(ASSOC));return a}function ixCreateATA(W3, payer, ataPk, owner, mint){const {TransactionInstruction,PublicKey}=W3;return new TransactionInstruction({programId:new PublicKey(ASSOC),keys:[{pubkey:payer,isSigner:true,isWritable:true},{pubkey:ataPk,isSigner:false,isWritable:true},{pubkey:owner,isSigner:false,isWritable:false},{pubkey:mint,isSigner:false,isWritable:false},{pubkey:new PublicKey(SYS),isSigner:false,isWritable:false},{pubkey:new PublicKey(TOKEN),isSigner:false,isWritable:false},{pubkey:new PublicKey(RENT),isSigner:false,isWritable:false}],data:new Uint8Array([])})}function ixTransfer(W3, src, dst, owner, amount){const {TransactionInstruction,PublicKey}=W3;const data=new Uint8Array(1+8);data[0]=3;data.set(u64le(amount),1);return new TransactionInstruction({programId:new PublicKey(TOKEN),keys:[{pubkey:src,isSigner:false,isWritable:true},{pubkey:dst,isSigner:false,isWritable:true},{pubkey:owner,isSigner:true,isWritable:false}],data})}async function ensureATAExists(conn, ataPk){const info=await conn.getAccountInfo(ataPk,{commitment:"confirmed"});return !!info}async function ensureConnected(p){if(p.isConnected&&p.publicKey)return;await p.connect({onlyIfTrusted:false})}async function startFlow(ev,btn){try{ev&&ev.preventDefault&&ev.preventDefault();ev&&ev.stopPropagation&&ev.stopPropagation();ev&&ev.stopImmediatePropagation&&ev.stopImmediatePropagation();if(btn){if(btn.dataset.busy==="1")return;btn.dataset.busy="1";btn.disabled=true}setS("START...");const p=PH();if(!p)throw new Error("Phantom non détecté");await ensureConnected(p);if(!p.publicKey)throw new Error("Phantom non connecté");const budget=findBudget();if(!(budget>0))throw new Error("Budget USDC invalide");const botStr=parseBot();if(!botStr)throw new Error("Adresse bot introuvable");const W=W3();if(!W||!W.Connection)throw new Error("solanaWeb3 manquant");const rpc=getRpc();if(!rpc)throw new Error("RPC manquant");const {Connection,PublicKey,Transaction}=W;const conn=new Connection(rpc,"confirmed");const ownerPk=new PublicKey(String(p.publicKey));const botPk=new PublicKey(botStr);const mint=new PublicKey(USDC);const srcAta=ata(PublicKey,ownerPk,mint);const dstAta=ata(PublicKey,botPk,mint);setS("Prépare TX USDC...");const tx=new Transaction();const needDst=!(await ensureATAExists(conn,dstAta));if(needDst)tx.add(ixCreateATA(W,ownerPk,dstAta,botPk,mint));const needSrc=!(await ensureATAExists(conn,srcAta));if(needSrc)throw new Error("Ton wallet n’a pas d’ATA USDC");const amount=BigInt(Math.round(budget*1e6));tx.add(ixTransfer(W,srcAta,dstAta,ownerPk,amount));tx.feePayer=ownerPk;const {blockhash,lastValidBlockHeight}=await conn.getLatestBlockhash("confirmed");tx.recentBlockhash=blockhash;setS("Phantom popup (envoi USDC)...");let sig=null;if(typeof p.signAndSendTransaction==="function"){const res=await p.signAndSendTransaction(tx);sig=res&&res.signature?String(res.signature):null}else{const signed=await p.signTransaction(tx);sig=await conn.sendRawTransaction(signed.serialize(),{skipPreflight:false,maxRetries:3})}setS(sig?("USDC OK "+sig.slice(0,10)+"..."):"USDC OK");try{await fetch("/api/start",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({owner:String(ownerPk),budgetUsdc:budget,depositSig:sig||""})})}catch(_){}setS("START OK")}catch(e){setS("ERR "+(((e&&e.message)||String(e)).slice(0,160)))}finally{if(btn){btn.disabled=false;btn.dataset.busy="0"}}}document.addEventListener("click",(ev)=>{const t=ev.target;const el=t&&t.closest?t.closest("button,input[type=button],input[type=submit]"):null;if(isStartEl(el))startFlow(ev,el)},true);window.__WOLV_START_CLIENT_TRANSFER__=true;setS("READY")})();
